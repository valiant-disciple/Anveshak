import cv2
import numpy as np
import subprocess
import sys

# FFmpeg command to capture live camera feed and overlay subtitles
ffmpeg_cmd = (
    'ffmpeg -i <your_camera_input> -vf "subtitles=<your_srt_file>" '
    '-f rawvideo -pix_fmt bgr24 -'
)

# OpenCV script to read frames from stdin and display them
def read_frame():
    try:
        # Read the raw video frame from stdin
        raw_frame = sys.stdin.buffer.read(640 * 480 * 3)  # Adjust frame size if needed
        if not raw_frame:
            return None

        # Convert the raw frame to a numpy array
        frame = np.frombuffer(raw_frame, dtype=np.uint8).reshape(480, 640, 3)

        return frame
    except Exception as e:
        print(f"Error reading frame: {e}")
        return None

# Start FFmpeg subprocess
ffmpeg_process = subprocess.Popen(
    ffmpeg_cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True
)

# Main loop to read frames and display them using OpenCV
while True:
    # Read a frame from stdin
    frame = read_frame()

    # Break the loop if no more frames are available
    if frame is None:
        break

    # Your OpenCV processing goes here
    # Example: Display the frame
    cv2.imshow("Frame", frame)
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

# Release FFmpeg subprocess
ffmpeg_process.terminate()

# Release OpenCV resources
cv2.destroyAllWindows()
